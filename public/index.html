<!DOCTYPE html>
<html>
<head>
	<title>Ping Pong Game</title>
</head>
<body>
	<canvas id="canvas"></canvas>
	<script type="text/javascript" src="js/app.js">
	</script>
	<script type="text/javascript">
		app.width = window.innerWidth;
		app.height = window.innerHeight;
		var player1score = 0;
		var player2score = 0;
		var ballSpeed = 0.3;
		const BLACK_BOX = 'black-box';
		const RED_BOX = 'red-box';
		const BALL = 'ball';
		const PLAYER_SCORE = 'player score';
		function addEventListenersForObjects(objSubject, negativeKey, positiveKey) {
			window.addEventListener('keydown', (e) => {
				if (e.key === negativeKey) {
					app.getNode(objSubject).directionY = -1;
				}
				if (e.key === positiveKey) {
					app.getNode(objSubject).directionY = 1;
				}
			}, false);

			window.addEventListener('keyup', (e) => {
				if (e.key === negativeKey || e.key === positiveKey) {
					app.getNode(objSubject).directionY = 0;
				}
			}, false);
		}
		app.reset = function(){
			for (var index in app.nodes) {
				var node = app.nodes[index];
				if (node.id == 'ball') {
					app.getNode(node.id).x = app.width/2 - app.getNode(node.id).width/2;
					app.getNode(node.id).directionX = (app.getNode(node.id).directionX<0)?1:-1;
				}
				app.getNode(node.id).directionY = 0;
				app.getNode(node.id).y = app.height / 2 - app.getNode(node.id).height / 2;
			}

		}
		function browserWindowSetup(){
			app.canvas.width = window.innerWidth;
			app.canvas.height = window.innerHeight;
			var body = document.getElementById('body');
			document.body.clientWidth = '100%';
			document.body.height = '100%';
			document.body.margin = '0px';
			document.body.style.overflowX = document.body.style.overflowY = 'hidden';
			document.body.diplay = 'block';
		}

		function initObjects(){
			const PLAYER_WIDTH = 50;
			const PLAYER_HEIGHT = 100;
			const BALL_DIAMETER = 20;

			const PLAYER_SCORE_X = 50;
			const PLAYER_SCORE_Y = 50;
			app.nodes.push({
				id : RED_BOX,
				width  : PLAYER_WIDTH,
				height : PLAYER_HEIGHT,
				x  : 0,
				y  : 0,
				color  : 'red',
				directionX: 0,
				directionY:0
			});
			app.nodes.push({
				id : BLACK_BOX,
				width  : PLAYER_WIDTH,
				height : PLAYER_HEIGHT,
				x: app.width-PLAYER_WIDTH,
				y  : 0,
				color  : 'black',
				directionX: 0,
				directionY:0
			});

			app.nodes.push({
				id : BALL,
				width  : BALL_DIAMETER,
				height : BALL_DIAMETER,
				color  : 'green',
				directionX: -1,
				directionY:0
			});
			app.renderTexts.push({
				id: PLAYER_SCORE,
				x: PLAYER_SCORE_X,
				y: PLAYER_SCORE_Y,
				font: '48px impact',
				textString: 'player 1: 0 player 2: 0',
				color: 'black'
			});
		}
		app.onInit = function(){
			browserWindowSetup();
			initObjects();

			app.reset();

			addEventListenersForObjects(RED_BOX,'w','s');
			addEventListenersForObjects(BLACK_BOX,'ArrowUp','ArrowDown');
			window.addEventListener('keydown',(e)=>{
				if(e.key === ' '){
					app.pause();
				}
			})
		};

		function collision(collA,collB){
			return !(app.getNode(collB).x>app.getNode(collA).x+app.getNode(collA).width
			|| app.getNode(collA).x>app.getNode(collB).x+app.getNode(collB).width
			|| app.getNode(collB).y>app.getNode(collA).y+app.getNode(collA).height
			|| app.getNode(collA).y>app.getNode(collB).y+app.getNode(collB).height);
		}

		function collisionResultFromBallVsPlayer(box){
			let redBoxCenter = {x:app.getNode(box).x+app.getNode(box).width/2,
					y:app.getNode(box).y+app.getNode(box).height/2};
				
				let ballCenter = {x:app.getNode(BALL).x+app.getNode(BALL).width/2,
					y:app.getNode(BALL).y+app.getNode(BALL).height/2};
				
				let XDist = (redBoxCenter.x-ballCenter.x);
				let YDist = (redBoxCenter.y-ballCenter.y);
				let mag = Math.sqrt(Math.pow(redBoxCenter.x-ballCenter.x,2)+Math.pow(redBoxCenter.y-ballCenter.y,2));
				if(mag != 0){
					app.getNode(BALL).directionX = -XDist/mag;
					app.getNode(BALL).directionY = -YDist/mag;
				}
		}
		function clamp(curr, min, max){
			return Math.min(Math.max(curr, min), max);
		}
		app.onUpdate = function(time){
			this.getNode(BLACK_BOX).y = clamp(this.getNode(BLACK_BOX).y+this.getNode(BLACK_BOX).directionY*time,
												0,
												app.height-this.getNode(BLACK_BOX).height);

			this.getNode(RED_BOX).y = clamp(this.getNode(RED_BOX).y+this.getNode(RED_BOX).directionY*time,
												0,
												app.height-this.getNode(RED_BOX).height);

			let totalBallSpeedY = this.getNode(BALL).directionY*time*ballSpeed;
			if(Math.max(this.getNode(BALL).y+totalBallSpeedY,0) == 0 ||
			Math.min(this.getNode(BALL).y+totalBallSpeedY,app.height-this.getNode(BALL).height) == app.height-this.getNode(BALL).height){
				this.getNode(BALL).directionY*=-1;
			}
			this.getNode(BALL).x+=this.getNode(BALL).directionX*time*ballSpeed;
			this.getNode(BALL).y+=this.getNode(BALL).directionY*time*ballSpeed;
			if(collision(RED_BOX,BALL)){
				collisionResultFromBallVsPlayer(RED_BOX);
			}
			
			if(collision(BLACK_BOX,BALL)){
				collisionResultFromBallVsPlayer(BLACK_BOX);
			}


			if(this.getNode(BALL).x+this.getNode(BALL).width<0){
				this.getRenderText(PLAYER_SCORE).textString = ("player 1: "+(player1score) + " player 2: "+(++player2score));
				app.reset();
			}
			else if(this.getNode(BALL).x>this.width){
				this.getRenderText(PLAYER_SCORE).textString =("player 1: "+(++player1score) + " player 2: "+(player2score));
				app.reset();
			}
		};
	</script>
</body>
</html>